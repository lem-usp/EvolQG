#' Corrected integration value
#'
#' Calculates the Young correction for integration, using bootstrap
#'
#' @param ind.data Matrix of residuals or indiviual measurments, or ajusted linear model
#' @param cv.level Coeficient of variation level choosen for integration index ajustment in linear model.
#' @param iterations Number of ressamples to take
#' @param num.cores Number of threads to use in computation. Requires doMC library.
#' @param ... aditional arguments passed to other methods
#' @return List with adjusted integration indexes, fitted models and simulated distributions of integration indexes and mean coeficient of variation
#' @references Young, N. M., Wagner, G. P., and Hallgrimsson, B. (2010).
#' Development and the evolvability of human limbs. Proceedings of the
#' National Academy of Sciences of the United States of America, 107(8),
#' 3400-5. doi:10.1073/pnas.0911856107
#' @author Diogo Melo, Guilherme Garcia
#' @seealso \code{\link{MeanMatrixStatistics}}, \code{\link{CalcR2}}
#' @rdname CalcR2CvCorrected
#' @export
#' @examples
#' integration.dist = CalcR2CvCorrected(iris[,1:4])
#'
#' #adjusted values
#' integration.dist[[1]]
#'
#' #ploting models
#' plot(integration.dist$dist[,1], integration.dist$dist[,3])
#' abline(integration.dist$models$r2)
#'
#' plot(integration.dist[[3]][,2], integration.dist[[3]][,3])
#' abline(integration.dist[[2]]$eVals_cv)
#' @keywords correlations
#' @keywords integrations

CalcR2CvCorrected  <- function(ind.data, ...) UseMethod("CalcR2CvCorrected")

#' @rdname CalcR2CvCorrected
#' @method CalcR2CvCorrected default
#' @S3method CalcR2CvCorrected default
CalcR2CvCorrected.default <- function (ind.data, cv.level = 0.06, iterations = 1000, num.cores = 1, ...) {
  cv <- function (x) return (sd(x)/mean(x))
  Stats = function(x) {
    cov.matrix = var(x)
    cor.matrix = cov2cor(cov.matrix)
    return(c(CalcR2(cor.matrix), cv(eigen(cov.matrix)$values), mean (apply (x, 2, cv))))
  }
  it.stats <- BootstrapRep(ind.data, iterations,
                           ComparisonFunc = function(x, y) y,
                           StatFunc = Stats,
                           num.cores = num.cores)
  colnames(it.stats) <- c("r2", "eVals_cv", "mean_cv")
  lm.r2 <- lm(it.stats[,1]~it.stats[,3])
  lm.eVals.cv <- lm(it.stats[,2]~it.stats[,3])
  adjusted.r2 <- lm.r2$coefficients %*% c(1, cv.level)
  adjusted.eVals.cv <- lm.eVals.cv$coefficients %*% c(1, cv.level)
  adjusted.integration  <-  c(adjusted.r2, adjusted.eVals.cv)
  names(adjusted.integration) <- c("r2", "eVals_cv")
  models <- list("r2" = lm.r2, "eVals_cv" = lm.eVals.cv)
  output <- list("adjusted.integration.index" = adjusted.integration, "models" = models, "dist" = it.stats)
  return (output)
}

#' @rdname CalcR2CvCorrected
#' @method CalcR2CvCorrected lm
#' @S3method CalcR2CvCorrected lm
CalcR2CvCorrected.lm <- function (ind.data, iterations = 1000, ...) {
  cv <- function (x) return (sd(x)/mean(x))
  orv <- ind.data$model[[1]]
  fac <- ind.data$model[-1]
  df <- ind.data$df.residual
  res <- residuals (model)
  size <- dim (res)
  straps <- array (0, c(size[1], iterations))
  r2 <- mcv <- evar <- c()
  i <- 1
  while (i <= iterations)
  {
    straps[,i] <- sample ((size[1]), replace = TRUE)
    corr <- cov2cor (var (res[straps[,i],]) * (size[1] - 1)/df)
    r2[i] <- mean (corr[lower.tri(corr)]^2)
    evar[i] <- cv (eigen(var (res[straps[,i],] * (size[1] - 1)/df))$values)
    orv.s <- orv[straps[,i],]
    fac.s <- fac[straps[,i],]
    tmp1 <- table (fac.s)
    tmp2 <- by (orv.s,fac.s,cv)
    tmp3 <- unlist (lapply (tmp2, mean))
    mcv[i] <- sum ((tmp3 * tmp1)/sum (tmp1))
    if (!is.na(mcv[i]))
      i <- i + 1
  }
  corr.or <- cov2cor (residual.matrix (model))
  r2.or <- mean (corr.or[lower.tri(corr.or)]^2)
  evar.or <- cv (eigen(residual.matrix (model))$values)
  tmp1 <- table (fac)
  tmp2 <- by (orv,fac,cv)
  tmp3 <- unlist (lapply (tmp2, mean))
  mcv.or <- sum ((tmp3 * tmp1)/sum (tmp1))
  return (list("sims" = cbind (r2, evar, mcv),
               "originals" = c(r2.or,evar.or,mcv.or),
               "CORmat" = corr.or,
               "perms" = straps))
}
